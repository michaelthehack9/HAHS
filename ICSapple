#!/bin/sh

# ===== Configuration =====
if [ -f key.txt ]; then
  SNIPEIT_API_KEY=$(cat key.txt)
else
  echo "❌ Error: key.txt not found. Please create it with your API key."
  exit 1
fi

if [ -z "$SNIPEIT_API_KEY" ]; then
  echo "❌ Error: key.txt is empty. Please add your API key."
  exit 1
fi

SNIPEIT_BASE_URL='http://ics.hasdhawks.org'
AUTH_HEADER="Authorization: Bearer $SNIPEIT_API_KEY"
ACCEPT_HEADER="Accept: application/json"
CONTENT_HEADER="Content-Type: application/json"

CACHE_FILE="/tmp/snipeit_assets_cache.json"

MODE="regular"

# ===== Functions =====

download_all_assets() {
  echo "⏳ Downloading all assets from Snipe-IT (this may take a while)..."
  PAGE_SIZE=500
  OFFSET=0
  MAX_ITER=30
  > "$CACHE_FILE"
  echo "[" > "$CACHE_FILE"

  FIRST=1
  while [ $MAX_ITER -gt 0 ]; do
    echo "Fetching assets offset $OFFSET ..."
    RESPONSE=$(curl -s -H "$AUTH_HEADER" -H "$ACCEPT_HEADER" \
      "$SNIPEIT_BASE_URL/api/v1/hardware?limit=$PAGE_SIZE&offset=$OFFSET")

    COUNT=$(echo "$RESPONSE" | jq '.rows | length // 0')
    echo "Assets this batch: $COUNT"

    if [ "$COUNT" -eq 0 ]; then
      echo "No more assets, stopping."
      break
    fi

    # Filter only assets with asset_tag length 8 or 9
    PAGE_ITEMS=$(echo "$RESPONSE" | jq '.rows | map(select(.asset_tag and ((.asset_tag | length == 8) or (.asset_tag | length == 9)))) | .[]')

    # Skip if no valid assets in this page
    [ -z "$PAGE_ITEMS" ] && {
      OFFSET=$((OFFSET + PAGE_SIZE))
      MAX_ITER=$((MAX_ITER - 1))
      continue
    }

    if [ $FIRST -eq 1 ]; then
      FIRST=0
      echo "$PAGE_ITEMS" | jq -c '.' | paste -sd "," - >> "$CACHE_FILE"
    else
      echo "," >> "$CACHE_FILE"
      echo "$PAGE_ITEMS" | jq -c '.' | paste -sd "," - >> "$CACHE_FILE"
    fi

    OFFSET=$((OFFSET + PAGE_SIZE))
    MAX_ITER=$((MAX_ITER - 1))
  done

  echo "]" >> "$CACHE_FILE"
  echo "✅ Finished downloading and filtering assets (8 or 9 character tags only)."
}


load_asset_by_tag() {
  local tag="$1"
  ASSET=$(jq -r --arg tag "$tag" '.[] | select(.asset_tag == $tag)' "$CACHE_FILE")
  if [ -z "$ASSET" ]; then
    return 1
  fi
  echo "$ASSET"
  return 0
}

search_assets_by_serial() {
  local query="$1"
  jq -r --arg q "$query" '
    .[]
    | select(
        .asset_tag and
        (.asset_tag | type == "string") and
        ((.asset_tag | length == 8) or (.asset_tag | length == 9)) and
        (.asset_tag | ascii_downcase | endswith($q | ascii_downcase))
      )
    | .asset_tag' "$CACHE_FILE"
}

get_asset_info() {
  local INPUT="$1"

  if [ "$MODE" = "serial" ]; then
    QUERY="$INPUT"
    echo "🔍 Searching cached assets for tags ending with '$QUERY'..."
    TMP_MATCHES="/tmp/matches_assets.txt"
    > "$TMP_MATCHES"
    search_assets_by_serial "$QUERY" >> "$TMP_MATCHES"
    MATCH_COUNT=$(wc -l < "$TMP_MATCHES")
    if [ "$MATCH_COUNT" -eq 0 ]; then
      echo "❌ No matching asset tags found in cache."
      return 1
    elif [ "$MATCH_COUNT" -eq 1 ]; then
      ASSET_TAG=$(head -n 1 "$TMP_MATCHES")
    else
      echo "Multiple matches found:"
      i=1
      while read -r tag; do
        echo "$i) $tag"
        i=$((i + 1))
      done < "$TMP_MATCHES"
      while true; do
        echo -n "Select a number (1-$MATCH_COUNT): "
        read CHOICE
        if echo "$CHOICE" | grep -Eq '^[0-9]+$' && [ "$CHOICE" -ge 1 ] && [ "$CHOICE" -le "$MATCH_COUNT" ]; then
          ASSET_TAG=$(sed -n "${CHOICE}p" "$TMP_MATCHES")
          break
        else
          echo "❌ Invalid selection."
        fi
      done
    fi
  else
    ASSET_TAG="$INPUT"
  fi

  if [ "$MODE" = "serial" ]; then
    ASSET_JSON=$(load_asset_by_tag "$ASSET_TAG")
    if [ $? -ne 0 ] || [ -z "$ASSET_JSON" ]; then
      echo "❌ Asset tag '$ASSET_TAG' not found in cache."
      return 1
    fi
  else
    ASSET_URL="$SNIPEIT_BASE_URL/api/v1/hardware?search=$ASSET_TAG&limit=100"
    RESPONSE=$(curl -s -H "$AUTH_HEADER" -H "$ACCEPT_HEADER" -H "$CONTENT_HEADER" "$ASSET_URL")
    ASSET_JSON=$(echo "$RESPONSE" | jq -r --arg TAG "$ASSET_TAG" '.rows[] | select(.asset_tag == $TAG)')
    if [ -z "$ASSET_JSON" ] || [ "$ASSET_JSON" = "null" ]; then
      echo "❌ Asset tag '$ASSET_TAG' not found."
      return 1
    fi
  fi

  ASSET_ID=$(echo "$ASSET_JSON" | jq '.id')
  MODEL_NAME=$(echo "$ASSET_JSON" | jq -r '.model.name // "Unknown Model"')
  CURRENT_USER=$(echo "$ASSET_JSON" | jq -r '.assigned_to.name // empty')
  echo "📦 Asset: $ASSET_TAG ($MODEL_NAME)"
  return 0
}

do_checkin() {
  if [ -n "$CURRENT_USER" ]; then
    echo "↩️  Checking in asset $ASSET_TAG..."
    CHECKIN_URL="$SNIPEIT_BASE_URL/api/v1/hardware/$ASSET_ID/checkin"
    CHECKIN_PAYLOAD=$(jq -n --arg note "Checked in via script" '{note: $note}')
    CHECKIN_RESPONSE=$(curl -s -X POST \
      -H "$AUTH_HEADER" -H "$ACCEPT_HEADER" -H "$CONTENT_HEADER" \
      -d "$CHECKIN_PAYLOAD" "$CHECKIN_URL")
    STATUS=$(echo "$CHECKIN_RESPONSE" | jq -r '.status // empty')
    [ "$STATUS" = "success" ] && echo "✅ Successfully checked in." || echo "❌ Check-in failed: $CHECKIN_RESPONSE"
  else
    echo "ℹ️  Asset was not checked out. Skipping check-in."
  fi
}

do_checkout() {
  while true; do
    echo -n "Enter LAST NAME to checkout to (blank to skip): "
    read LNAME
    [ -z "$LNAME" ] && { echo "Skipping checkout."; break; }
    echo "🔍 Searching users by last name '$LNAME'..."
    USERS_URL="$SNIPEIT_BASE_URL/api/v1/users?search=$LNAME&limit=100"
    USERS_RESPONSE=$(curl -s -H "$AUTH_HEADER" -H "$ACCEPT_HEADER" "$USERS_URL")
    TMP_USERS="/tmp/matches_users.txt"
    echo "$USERS_RESPONSE" | jq -r '.rows[] | select(.last_name | test("'"$LNAME"'"; "i")) | "\(.id)|\(.name)"' > "$TMP_USERS"
    USER_COUNT=$(wc -l < "$TMP_USERS")
    if [ "$USER_COUNT" -eq 0 ]; then
      echo "❌ No users found."
      continue
    elif [ "$USER_COUNT" -eq 1 ]; then
      LINE=$(head -n 1 "$TMP_USERS")
    else
      echo "Multiple users found:"
      i=1
      while IFS='|' read -r id name; do
        echo "$i) $name (ID: $id)"
        i=$((i + 1))
      done < "$TMP_USERS"
      while true; do
        echo -n "Select a number (1-$USER_COUNT): "
        read CHOICE
        if echo "$CHOICE" | grep -Eq '^[0-9]+$' && [ "$CHOICE" -ge 1 ] && [ "$CHOICE" -le "$USER_COUNT" ]; then
          LINE=$(sed -n "${CHOICE}p" "$TMP_USERS")
          break
        else
          echo "❌ Invalid selection."
        fi
      done
    fi
    USER_ID=$(echo "$LINE" | cut -d'|' -f1)
    USER_NAME=$(echo "$LINE" | cut -d'|' -f2-)
    echo "📤 Checking out asset $ASSET_TAG to $USER_NAME..."
    CHECKOUT_URL="$SNIPEIT_BASE_URL/api/v1/hardware/$ASSET_ID/checkout"
    CHECKOUT_PAYLOAD=$(jq -n --arg note "Checked out via script" --arg uid "$USER_ID" \
      '{checkout_to_type: "user", assigned_user: ($uid | tonumber), note: $note}')
    CHECKOUT_RESPONSE=$(curl -s -X POST \
      -H "$AUTH_HEADER" -H "$ACCEPT_HEADER" -H "$CONTENT_HEADER" \
      -d "$CHECKOUT_PAYLOAD" "$CHECKOUT_URL")
    STATUS=$(echo "$CHECKOUT_RESPONSE" | jq -r '.status // empty')
    [ "$STATUS" = "success" ] && echo "✅ Checked out to $USER_NAME" || echo "❌ Checkout failed: $CHECKOUT_RESPONSE"
    break
  done
}

do_audit() {
  echo "📋 Auditing asset $ASSET_TAG..."
  AUDIT_URL="$SNIPEIT_BASE_URL/api/v1/hardware/audit"
  AUDIT_PAYLOAD=$(jq -n --arg asset_tag "$ASSET_TAG" --arg note "Audited via script" '{asset_tag: $asset_tag, note: $note}')
  AUDIT_RESPONSE=$(curl -s -X POST \
    -H "$AUTH_HEADER" -H "$ACCEPT_HEADER" -H "$CONTENT_HEADER" \
    -d "$AUDIT_PAYLOAD" "$AUDIT_URL")
  STATUS=$(echo "$AUDIT_RESPONSE" | jq -r '.status // empty')
  [ "$STATUS" = "success" ] && echo "✅ Audit recorded." || echo "❌ Audit failed: $AUDIT_RESPONSE"
}

show_assigned() {
  if [ -n "$CURRENT_USER" ]; then
    echo "🔗 Currently assigned to: $CURRENT_USER"
  else
    echo "🔗 Asset is not assigned to anyone."
  fi
}

# ===== Start Script =====

echo "Select mode:"
echo "1) regular (search by full asset tag, no caching)"
echo "2) serial  (loads all assets once and searches cached data by last characters)"
echo -n "Enter mode number (1 or 2): "
read MODE_CHOICE
case "$MODE_CHOICE" in
  2) MODE="serial" ;;
  *) MODE="regular" ;;
esac

if [ "$MODE" = "serial" ]; then
  download_all_assets
fi

echo "Choose actions (comma separated): audit, checkin, checkout, assigned"
read -p "> " CHOICES
CHOICES=$(echo "$CHOICES" | tr '[:upper:]' '[:lower:]')

while true; do
  if [ "$MODE" = "serial" ]; then
    echo -n "Enter LAST characters of Asset Tag to search (e.g. 'FYN9'): "
  else
    echo -n "Enter FULL Asset Tag: "
  fi
  read INPUT
  get_asset_info "$INPUT"
  if [ $? -ne 0 ]; then
    continue
  fi

  RUN_ORDER=""
  case "$CHOICES" in *assigned*) RUN_ORDER="$RUN_ORDER assigned" ;; esac
  case "$CHOICES" in *checkout*) RUN_ORDER="$RUN_ORDER checkin checkout" ;; esac
  case "$CHOICES" in *checkin*)  RUN_ORDER="$RUN_ORDER checkin" ;; esac
  case "$CHOICES" in *audit*)    RUN_ORDER="$RUN_ORDER audit" ;; esac

  for action in $RUN_ORDER; do
    case "$action" in
      checkin)  do_checkin ;;
      checkout) do_checkout ;;
      assigned) show_assigned ;;
      audit)    do_audit ;;
    esac
  done
done
